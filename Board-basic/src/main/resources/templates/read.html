<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시글 읽기</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>

<!-- Header / Nav -->
<div th:replace="layout :: header"></div>
<div th:replace="layout :: nav"></div>

<!-- 본문 -->
<div class="container mt-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <span>번호: <span th:text="${posts.id}"></span></span>
            <span th:text="${posts.createdDate}"></span>
        </div>

        <div class="card-header d-flex justify-content-between">
            <span>작성자: <span th:text="${posts.writer}"></span></span>
            <span><i class="bi bi-eye-fill"></i> <span th:text="${posts.view}"></span></span>
        </div>

        <div class="card-body">
            <div class="form-group mb-3">
                <label for="title">제목</label>
                <input type="text" class="form-control" id="title" th:value="${posts.title}" readonly>
            </div>
            <div class="form-group">
                <label for="content">내용</label>
                <textarea rows="8" class="form-control" id="content" readonly th:text="${posts.content}"></textarea>
            </div>
        </div>
    </div>

    <!-- 버튼 -->
    <div class="mt-3 text-right">
        <a href="/" class="btn btn-secondary bi bi-arrow-return-left"> 목록</a>

        <!-- 수정 및 삭제는 로그인 상태 + 본인이 작성한 글일 경우만 표시 -->
        <a th:if="${user != null and user.nickname == posts.writer}"
           th:href="@{/posts/update/{id}(id=${posts.id})}"
           class="btn btn-primary bi bi-pencil-square"> 수정</a>

        <button th:if="${user != null and user.nickname == posts.writer}"
                type="button"
                id="btn-delete"
                class="btn btn-danger bi bi-trash"> 삭제</button>
    </div>

    <!-- 댓글 -->
    <hr/>
    <div id="comments">

        <h5>댓글</h5>

        <!-- 목록 -->
        <div th:if="${#lists.isEmpty(comments)}">아직 댓글이 없습니다.</div>
        <ul class="list-group mb-3" th:if="${!#lists.isEmpty(comments)}">
            <li class="list-group-item d-flex justify-content-between align-items-start"
                th:each="c : ${comments}">
                <div>
                    <div class="fw-bold" th:text="${c.writer}">닉네임</div>
                    <div th:text="${c.content}">내용</div>
                    <small class="text-muted" th:text="${c.createdDate}">2025.08.11 12:00</small>
                </div>

                <!-- 본인 또는 관리자만 삭제 버튼 -->
                <div
                        xmlns:sec="https://www.thymeleaf.org/extras/spring-security6"
                        sec:authorize="isAuthenticated()">
                    <form th:if="${#authentication.principal?.user?.nickname == c.writer} or ${#authorization.expression('hasRole(''ADMIN'')')}"
                          th:action="@{'/posts/' + ${posts.id} + '/comments/' + ${c.id} + '/delete'}"
                          method="post" style="display:inline;">
<!--                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                        <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                    </form>
                </div>
            </li>
        </ul>

        <!-- 작성 폼: 로그인 사용자만 -->
        <div xmlns:sec="https://www.thymeleaf.org/extras/spring-security6" sec:authorize="isAuthenticated()">
            <form th:action="@{'/posts/' + ${posts.id} + '/comments'}" method="post">
<!--                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                <div class="form-group">
        <textarea name="content" class="form-control" rows="3" maxlength="1000"
                  placeholder="댓글을 입력하세요." required></textarea>
                </div>
                <div class="mt-2 text-right">
                    <button type="submit" class="btn btn-primary">등록</button>
                </div>
            </form>
        </div>

        <div xmlns:sec="https://www.thymeleaf.org/extras/spring-security6" sec:authorize="isAnonymous()"
             class="text-muted">
            댓글을 작성하려면 <a th:href="@{/login}">로그인</a>하세요.
        </div>

    </div>
</div>

<!-- Footer -->
<div th:replace="layout :: footer"></div>

<!-- JS -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteBtn = document.querySelector("#btn-delete");
        if (deleteBtn) {
            deleteBtn.addEventListener("click", function () {
                const postId = /*[[${posts.id}]]*/ '0';
                if (confirm("정말 삭제하시겠습니까?")) {
                    fetch(`/posts/delete/${postId}`, { method: 'POST' })
                        .then(() => window.location.href = "/");
                }
            });
        }
    });
</script>

</body>
</html>
